{"version":3,"sources":["app.js"],"names":["a","b","mqtt","require","client","connect","moment","checksum","message","calculatedSum","checkSum","length","i","v","console","log","toString","on","subscribe","topic","slice","mac1","mac2","len","payload","type","name","mac1String","mac2String","val1","readUInt32LE","val2","val3","batt","publish","unix","format"],"mappings":"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","file":"app.js","sourcesContent":["export default (a, b) => a + b\nconst mqtt = require('mqtt')\nconst client = mqtt.connect('mqtt://mqtt.cmmc.io')\nconst moment = require('moment')\n\nlet checksum = (message) => {\n  let calculatedSum = 0\n  let checkSum = message[message.length - 1]\n  for (let i = 0; i < message.length - 1; i++) {\n    let v = message[i]\n    calculatedSum ^= v\n  }\n  console.log(`calculated sum = ${calculatedSum.toString(16)}`)\n  console.log(`check sum = ${checkSum.toString(16)}`)\n  return calculatedSum === checkSum\n}\n\nclient.on('connect', function () {\n  client.subscribe('CMMC/espnow/#')\n})\n\nclient.on('message', function (topic, message) {\n  console.log('================')\n  if (message[message.length - 1] === 0x0d) {\n    message = message.slice(0, message.length - 1)\n  }\n\n  console.log(message)\n  console.log('================')\n  console.log(message.length)\n\n  if (checksum(message)) {\n    let mac1, mac2\n    if (message[0] === 0xfc && message[1] === 0xfd) {\n      console.log(message)\n      mac1 = message.slice(2, 2 + 6)\n      mac2 = message.slice(2 + 6, 2 + 6 + 6)\n      let len = message[2 + 6 + 6]\n      let payload = message.slice(2 + 6 + 6 + 1, message.length - 1)\n      console.log(`len = ${len}, payload = ${payload.toString('hex')}`)\n      // if (checksum(payload)) {\n      //   console.log('YAY!')\n      // }\n      if (payload[0] === 0xff && payload[1] === 0xfa) {\n        let type = payload.slice(2, 5)\n        let name = payload.slice(5, 11)\n        let mac1String = mac1.toString('hex')\n        let mac2String = mac2.toString('hex')\n        let [val1, val2, val3, batt] = [\n          payload.readUInt32LE(11) || 0,\n          payload.readUInt32LE(15) || 0,\n          payload.readUInt32LE(19) || 0,\n          payload.readUInt32LE(23) || 0\n        ]\n\n        console.log(`type = `, type)\n        console.log(`name = `, name.toString())\n        console.log(`val1 = `, val1)\n        console.log(`val2 = `, val2)\n        console.log(`val3 = `, val3)\n        console.log(`batt = `, batt)\n        console.log(`[master] mac1 = `, mac1String)\n\n        console.log(`[ slave] mac2 = `, mac2String)\n        client.publish(`CMMC/espnow/${mac1String}/${mac2String}/val1`, val1.toString())\n        client.publish(`CMMC/espnow/${mac1String}/${mac2String}/val2`, val2.toString())\n        client.publish(`CMMC/espnow/${mac1String}/${mac2String}/batt`, batt.toString())\n        client.publish(`CMMC/espnow/${mac1String}/${mac2String}/val3`, val3.toString())\n        client.publish(`CMMC/espnow/${mac1String}/${mac2String}/nickname`, name.toString())\n        client.publish(`CMMC/espnow/${mac1String}/${mac2String}/sensor`, type.toString('hex'))\n        client.publish(`CMMC/espnow/${mac1String}/${mac2String}/updated`, moment().unix().toString())\n        client.publish(`CMMC/espnow/${mac1String}/${mac2String}/updatedText`, moment().format('MMMM Do YYYY, h:mm:ss a'))\n      } else {\n        console.log('invalid header')\n      }\n    }\n  } else {\n    console.log('invalid checksum')\n  }\n})\n"],"sourceRoot":"/Users/nat/espnow_serial_bridge/espnow-mqtt/dist"}